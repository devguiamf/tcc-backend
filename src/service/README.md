# Service Module

## Description

The Service module manages services offered by stores. Each service belongs to a store, and stores are linked to PRESTADOR users. Services can be created, updated, and deleted by authenticated users who own the store. The module handles CRUD operations for services with authentication and authorization checks.

## Endpoints

### Create Service
- **Method**: `POST`
- **Path**: `/services`
- **Authentication**: Required (JWT Bearer Token)
- **Body**: `CreateServiceDto`
- **Response**: `ServiceOutput` (201 Created)
- **Description**: Creates a new service for the authenticated user's store. The store is automatically retrieved from the user's token.

### List All Services
- **Method**: `GET`
- **Path**: `/services`
- **Response**: `ServiceOutput[]` (200 OK)
- **Description**: Retrieves all services from all stores (public endpoint)

### Get My Services
- **Method**: `GET`
- **Path**: `/services/my-services`
- **Authentication**: Required (JWT Bearer Token)
- **Response**: `ServiceOutput[]` (200 OK)
- **Description**: Retrieves all services from the authenticated user's store

### Get Services by Store ID
- **Method**: `GET`
- **Path**: `/services/store/:storeId`
- **Response**: `ServiceOutput[]` (200 OK)
- **Description**: Retrieves all services for a specific store (public endpoint)

### Get Service by ID
- **Method**: `GET`
- **Path**: `/services/:id`
- **Response**: `ServiceOutput` (200 OK)
- **Error**: 404 Not Found if service doesn't exist

### Update Service
- **Method**: `PUT`
- **Path**: `/services/:id`
- **Authentication**: Required (JWT Bearer Token)
- **Body**: `UpdateServiceDto`
- **Response**: `ServiceOutput` (200 OK)
- **Error**: 
  - 404 Not Found if service doesn't exist
  - 403 Forbidden if user doesn't own the store that contains this service

### Delete Service
- **Method**: `DELETE`
- **Path**: `/services/:id`
- **Authentication**: Required (JWT Bearer Token)
- **Response**: 204 No Content
- **Error**: 
  - 404 Not Found if service doesn't exist
  - 403 Forbidden if user doesn't own the store that contains this service

### Test Endpoint
- **Method**: `GET`
- **Path**: `/services/admin/test`
- **Response**: `{ message: string }` (200 OK)

## Business Rules

1. **Store Ownership**: 
   - Services can only be created, updated, or deleted by users who own the store.
   - The store is automatically retrieved from the authenticated user's token.
   - Users who don't have a store will receive a 404 Not Found error.

2. **Store Association**: 
   - Each service must be associated with a store.
   - The store is automatically linked when creating a service (retrieved from user's token).
   - Services cannot be moved between stores.

3. **Authorization**: 
   - Only the store owner can update or delete their services.
   - Attempting to modify services from another user's store results in a 403 Forbidden error.

## Data Validation

### CreateServiceDto

- **title**: 
  - Required
  - Type: string
  - Minimum length: 2 characters

- **description**: 
  - Required
  - Type: string
  - Minimum length: 10 characters

- **price**: 
  - Required
  - Type: number
  - Minimum value: 0.01
  - Stored as decimal(10,2) in database

- **durationMinutes**: 
  - Required
  - Type: number (integer)
  - Minimum value: 1
  - Maximum value: 1440 (24 hours)

- **imageUrl**: 
  - Optional
  - Type: string
  - Must be a valid URL format

### UpdateServiceDto

All fields from `CreateServiceDto` are optional. Same validation rules apply when fields are provided.

## Service Output Structure

```typescript
{
  id: string;                    // UUID
  title: string;
  description: string;
  price: number;                 // Decimal value (converted from database decimal)
  durationMinutes: number;        // Integer (1-1440)
  imageUrl?: string;              // Optional URL
  storeId: string;                // UUID of the store
  createdAt: Date;
  updatedAt: Date;
}
```

## Authentication

The module uses JWT authentication for protected endpoints:

1. **Token Extraction**: The `JwtAuthGuard` extracts the Bearer token from the `Authorization` header.
2. **User Identification**: The `@CurrentUser()` decorator extracts the user ID from the decoded token.
3. **Store Lookup**: The service automatically looks up the store associated with the user ID.

### Token Format

```
Authorization: Bearer <jwt-token>
```

The JWT token should contain the user ID in the `sub` claim (as generated by the Auth module).

## Error Responses

### 400 Bad Request
- Invalid data format
- Validation errors (e.g., price < 0.01, durationMinutes < 1 or > 1440)
- Invalid URL format for imageUrl

### 401 Unauthorized
- Missing or invalid JWT token
- Token not provided in Authorization header

### 403 Forbidden
- User attempting to update/delete a service from another user's store
- User doesn't have permission to modify the service

### 404 Not Found
- Service not found
- Store not found for the authenticated user (when creating/listing services)

## Database Relations

- **StoreEntity** (Many-to-One): Each service belongs to one store
- Foreign key: `storeId` references `stores.id`
- Cascade: Services are not automatically deleted when a store is deleted (should be handled manually or via database constraints)

## Dependencies

- `ServiceRepository`: Handles database operations
- `StoreRepository`: Validates store ownership and retrieves store by user ID
- `JwtAuthGuard`: Validates JWT tokens and extracts user information
- `CurrentUser` decorator: Extracts user ID from request
- TypeORM: For entity management and database access

## Module Exports

- `ServiceService`: Business logic service
- `ServiceRepository`: Database repository

## Example Usage Flow

1. **User Authentication**: User logs in and receives a JWT token
2. **Create Service**: User sends POST request with token in Authorization header
   - System extracts user ID from token
   - System looks up user's store
   - Service is created and linked to the store
3. **List Services**: User can list their own services or all services
4. **Update/Delete**: User can only modify services from their own store

## Notes

- Price is stored as decimal(10,2) in the database for precision
- Duration is stored in minutes (1-1440 range covers 1 minute to 24 hours)
- Image URL is optional and should point to an accessible image resource
- Services are public (can be viewed by anyone), but only owners can modify them
- The module automatically associates services with the authenticated user's store

